THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){var e,r,t,i,o,n,a,s,l,c,p,E=[],u=0,f=[],h=0,d=[],m=0,v=[],y=0,x=[],R=0,T={objects:[],lights:[],elements:[]},H=new THREE.Vector3,g=new THREE.Vector4,w=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),S=new THREE.Box3,M=new Array(3),b=new THREE.Matrix4,z=new THREE.Matrix4,V=new THREE.Matrix4,j=new THREE.Matrix3,O=new THREE.Frustum,C=new THREE.Vector4,L=new THREE.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var W=new function(){var e=[],r=[],i=[],n=null,s=new THREE.Matrix3;function l(e){var r=e.position,t=e.positionWorld,i=e.positionScreen;t.copy(r).applyMatrix4(p),i.copy(t).applyMatrix4(z);var o=1/i.w;i.x*=o,i.y*=o,i.z*=o,e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1}function c(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(M[0]=e.positionScreen,M[1]=r.positionScreen,M[2]=t.positionScreen,w.intersectsBox(S.setFromPoints(M)))}function E(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(t){n=t,s.getNormalMatrix(n.matrixWorld),e.length=0,r.length=0,i.length=0},projectVertex:l,checkTriangleVisibility:c,checkBackfaceCulling:E,pushVertex:function(e,r,i){(t=B()).position.set(e,r,i),l(t)},pushNormal:function(r,t,i){e.push(r,t,i)},pushColor:function(e,t,i){r.push(e,t,i)},pushUv:function(e,r){i.push(e,r)},pushLine:function(e,t){var i=f[e],o=f[t];i.positionScreen.copy(i.position).applyMatrix4(V),o.positionScreen.copy(o.position).applyMatrix4(V),!0===I(i.positionScreen,o.positionScreen)&&(i.positionScreen.multiplyScalar(1/i.positionScreen.w),o.positionScreen.multiplyScalar(1/o.positionScreen.w),(a=F()).id=n.id,a.v1.copy(i),a.v2.copy(o),a.z=Math.max(i.positionScreen.z,o.positionScreen.z),a.renderOrder=n.renderOrder,a.material=n.material,n.material.vertexColors===THREE.VertexColors&&(a.vertexColors[0].fromArray(r,3*e),a.vertexColors[1].fromArray(r,3*t)),T.elements.push(a))},pushTriangle:function(t,a,l,p){var u=f[t],h=f[a],d=f[l];if(!1!==c(u,h,d)&&(p.side===THREE.DoubleSide||!0===E(u,h,d))){(o=N()).id=n.id,o.v1.copy(u),o.v2.copy(h),o.v3.copy(d),o.z=(u.positionScreen.z+h.positionScreen.z+d.positionScreen.z)/3,o.renderOrder=n.renderOrder,H.subVectors(d.position,h.position),g.subVectors(u.position,h.position),H.cross(g),o.normalModel.copy(H),o.normalModel.applyMatrix3(s).normalize();for(var m=0;m<3;m++){var v=o.vertexNormalsModel[m];v.fromArray(e,3*arguments[m]),v.applyMatrix3(s).normalize();var y=o.uvs[m];y.fromArray(i,2*arguments[m])}o.vertexNormalsLength=3,o.material=p,p.vertexColors!==THREE.FaceColors&&p.vertexColors!==THREE.VertexColors||o.color.fromArray(r,3*t),T.elements.push(o)}}}};function k(t){(e=function(){if(r===u){var e=new THREE.RenderableObject;return E.push(e),u++,r++,e}return E[r++]}()).id=t.id,e.object=t,H.setFromMatrixPosition(t.matrixWorld),H.applyMatrix4(z),e.z=H.z,e.renderOrder=t.renderOrder,T.objects.push(e)}function A(e,r,t){var i=1/e.w;e.z*=i,e.z>=-1&&e.z<=1&&((l=function(){if(c===R){var e=new THREE.RenderableSprite;return x.push(e),R++,c++,e}return x[c++]}()).id=r.id,l.x=e.x*i,l.y=e.y*i,l.z=e.z,l.renderOrder=r.renderOrder,l.object=r,l.rotation=r.rotation,l.scale.x=r.scale.x*Math.abs(l.x-(e.x+t.projectionMatrix.elements[0])/(e.w+t.projectionMatrix.elements[12])),l.scale.y=r.scale.y*Math.abs(l.y-(e.y+t.projectionMatrix.elements[5])/(e.w+t.projectionMatrix.elements[13])),l.material=r.material,T.elements.push(l))}function B(){if(i===h){var e=new THREE.RenderableVertex;return f.push(e),h++,i++,e}return f[i++]}function N(){if(n===m){var e=new THREE.RenderableFace;return d.push(e),m++,n++,e}return d[n++]}function F(){if(s===y){var e=new THREE.RenderableLine;return v.push(e),y++,s++,e}return v[s++]}function P(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}function I(e,r){var t=0,i=1,o=e.z+e.w,n=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;return o>=0&&n>=0&&a>=0&&s>=0||!(o<0&&n<0||a<0&&s<0)&&(o<0?t=Math.max(t,o/(o-n)):n<0&&(i=Math.min(i,o/(o-n))),a<0?t=Math.max(t,a/(a-s)):s<0&&(i=Math.min(i,a/(a-s))),!(i<t)&&(e.lerp(r,t),r.lerp(e,1-i),!0))}this.projectScene=function(e,t,l,E){n=0,s=0,c=0,T.elements.length=0,!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),b.copy(t.matrixWorldInverse),z.multiplyMatrices(t.projectionMatrix,b),O.setFromMatrix(z),r=0,T.objects.length=0,T.lights.length=0,function e(r){if(!1!==r.visible){if(r instanceof THREE.Light)T.lights.push(r);else if(r instanceof THREE.Mesh||r instanceof THREE.Line||r instanceof THREE.Points){if(!1===r.material.visible)return;if(!0===r.frustumCulled&&!1===O.intersectsObject(r))return;k(r)}else if(r instanceof THREE.Sprite){if(!1===r.material.visible)return;if(!0===r.frustumCulled&&!1===O.intersectsSprite(r))return;k(r)}for(var t=r.children,i=0,o=t.length;i<o;i++)e(t[i])}}(e),!0===l&&T.objects.sort(P);for(var u=T.objects,h=0,d=u.length;h<d;h++){var m=u[h].object,v=m.geometry;if(W.setObject(m),p=m.matrixWorld,i=0,m instanceof THREE.Mesh){if(v instanceof THREE.BufferGeometry){var y=m.material,x=Array.isArray(y),R=v.attributes,w=v.groups;if(void 0===R.position)continue;for(var S=0,M=(Me=R.position.array).length;S<M;S+=3){var G=Me[S],D=Me[S+1],U=Me[S+2];if(!0===y.morphTargets)for(var X=v.morphAttributes.position,Y=v.morphTargetsRelative,Z=m.morphTargetInfluences,q=0,J=X.length;q<J;q++){if(0!==(le=Z[q])){var K=X[q];Y?(G+=K.getX(S/3)*le,D+=K.getY(S/3)*le,U+=K.getZ(S/3)*le):(G+=(K.getX(S/3)-Me[S])*le,D+=(K.getY(S/3)-Me[S+1])*le,U+=(K.getZ(S/3)-Me[S+2])*le)}}W.pushVertex(G,D,U)}if(void 0!==R.normal){var Q=R.normal.array;for(S=0,M=Q.length;S<M;S+=3)W.pushNormal(Q[S],Q[S+1],Q[S+2])}if(void 0!==R.color)for(S=0,M=(we=R.color.array).length;S<M;S+=3)W.pushColor(we[S],we[S+1],we[S+2]);if(void 0!==R.uv){var $=R.uv.array;for(S=0,M=$.length;S<M;S+=2)W.pushUv($[S],$[S+1])}if(null!==v.index){var _=v.index.array;if(w.length>0)for(var ee=0;ee<w.length;ee++){var re=w[ee];if(void 0!==(y=!0===x?m.material[re.materialIndex]:m.material))for(S=re.start,M=re.start+re.count;S<M;S+=3)W.pushTriangle(_[S],_[S+1],_[S+2],y)}else for(S=0,M=_.length;S<M;S+=3)W.pushTriangle(_[S],_[S+1],_[S+2],y)}else if(w.length>0)for(ee=0;ee<w.length;ee++){re=w[ee];if(void 0!==(y=!0===x?m.material[re.materialIndex]:m.material))for(S=re.start,M=re.start+re.count;S<M;S+=3)W.pushTriangle(S,S+1,S+2,y)}else for(S=0,M=Me.length/3;S<M;S+=3)W.pushTriangle(S,S+1,S+2,y)}else if(v instanceof THREE.Geometry){var te=v.vertices,ie=v.faces,oe=v.faceVertexUvs[0];j.getNormalMatrix(p);y=m.material,x=Array.isArray(y);for(var ne=0,ae=te.length;ne<ae;ne++){var se=te[ne];if(H.copy(se),!0===y.morphTargets)for(X=v.morphTargets,Z=m.morphTargetInfluences,q=0,J=X.length;q<J;q++){var le;if(0!==(le=Z[q])){var ce=(K=X[q]).vertices[ne];H.x+=(ce.x-se.x)*le,H.y+=(ce.y-se.y)*le,H.z+=(ce.z-se.z)*le}}W.pushVertex(H.x,H.y,H.z)}for(var pe=0,Ee=ie.length;pe<Ee;pe++){var ue=ie[pe];if(void 0!==(y=!0===x?m.material[ue.materialIndex]:m.material)){var fe=y.side,he=f[ue.a],de=f[ue.b],me=f[ue.c];if(!1!==W.checkTriangleVisibility(he,de,me)){var ve=W.checkBackfaceCulling(he,de,me);if(fe!==THREE.DoubleSide){if(fe===THREE.FrontSide&&!1===ve)continue;if(fe===THREE.BackSide&&!0===ve)continue}(o=N()).id=m.id,o.v1.copy(he),o.v2.copy(de),o.v3.copy(me),o.normalModel.copy(ue.normal),!1!==ve||fe!==THREE.BackSide&&fe!==THREE.DoubleSide||o.normalModel.negate(),o.normalModel.applyMatrix3(j).normalize();for(var ye=ue.vertexNormals,xe=0,Re=Math.min(ye.length,3);xe<Re;xe++){var Te=o.vertexNormalsModel[xe];Te.copy(ye[xe]),!1!==ve||fe!==THREE.BackSide&&fe!==THREE.DoubleSide||Te.negate(),Te.applyMatrix3(j).normalize()}o.vertexNormalsLength=ye.length;var He=oe[pe];if(void 0!==He)for(var ge=0;ge<3;ge++)o.uvs[ge].copy(He[ge]);o.color=ue.color,o.material=y,o.z=(he.positionScreen.z+de.positionScreen.z+me.positionScreen.z)/3,o.renderOrder=m.renderOrder,T.elements.push(o)}}}}}else if(m instanceof THREE.Line){if(V.multiplyMatrices(z,p),v instanceof THREE.BufferGeometry){if(void 0!==(R=v.attributes).position){for(S=0,M=(Me=R.position.array).length;S<M;S+=3)W.pushVertex(Me[S],Me[S+1],Me[S+2]);if(void 0!==R.color){var we;for(S=0,M=(we=R.color.array).length;S<M;S+=3)W.pushColor(we[S],we[S+1],we[S+2])}if(null!==v.index)for(S=0,M=(_=v.index.array).length;S<M;S+=2)W.pushLine(_[S],_[S+1]);else{var Se=m instanceof THREE.LineSegments?2:1;for(S=0,M=Me.length/3-1;S<M;S+=Se)W.pushLine(S,S+1)}}}else if(v instanceof THREE.Geometry){if(0===(te=m.geometry.vertices).length)continue;(he=B()).positionScreen.copy(te[0]).applyMatrix4(V);for(Se=m instanceof THREE.LineSegments?2:1,ne=1,ae=te.length;ne<ae;ne++)(he=B()).positionScreen.copy(te[ne]).applyMatrix4(V),(ne+1)%Se>0||(de=f[i-2],C.copy(he.positionScreen),L.copy(de.positionScreen),!0===I(C,L)&&(C.multiplyScalar(1/C.w),L.multiplyScalar(1/L.w),(a=F()).id=m.id,a.v1.positionScreen.copy(C),a.v2.positionScreen.copy(L),a.z=Math.max(C.z,L.z),a.renderOrder=m.renderOrder,a.material=m.material,m.material.vertexColors===THREE.VertexColors&&(a.vertexColors[0].copy(m.geometry.colors[ne]),a.vertexColors[1].copy(m.geometry.colors[ne-1])),T.elements.push(a)))}}else if(m instanceof THREE.Points){if(V.multiplyMatrices(z,p),v instanceof THREE.Geometry)for(ne=0,ae=(te=m.geometry.vertices).length;ne<ae;ne++){se=te[ne];g.set(se.x,se.y,se.z,1),g.applyMatrix4(V),A(g,m,t)}else if(v instanceof THREE.BufferGeometry){if(void 0!==(R=v.attributes).position){var Me;for(S=0,M=(Me=R.position.array).length;S<M;S+=3)g.set(Me[S],Me[S+1],Me[S+2],1),g.applyMatrix4(V),A(g,m,t)}}}else m instanceof THREE.Sprite&&(m.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,m.matrixWorld),g.set(p.elements[12],p.elements[13],p.elements[14],1),g.applyMatrix4(z),A(g,m,t))}return!0===E&&T.elements.sort(P),T}}
